//incluir os motores
#include <Servo.h>

// declarar as variaveis do TRF05
int TrigPin = 7;
int EcoPin = 8;

//variaveis do Ping Prallax
const int PingPin = A1;
int PingVolt = A0;

//Duração
long durationTRF;
long durationPing;

//distancia
int cmTRF;
int cmPing;


int Led = 2;
Servo motorE;
Servo motorD;
 
 
 void setup() {
  
  Serial.begin(9600);
  pinMode(TrigPin,OUTPUT);
  pinMode(EcoPin,INPUT);
  pinMode(Led, OUTPUT);
  pinMode(PingVolt, OUTPUT);

}



void loop() {

  int leituraTRF;
  int leituraPing;

  //sinal recebido do app ao TRF
  byte cmd = Serial.read();
  if (cmTRF > 50){
    cmTRF = 50;
  }

  if(cmPing > 30){
    cmTRF = 150;
  }

  byte dataToSentTRF;
    dataToSentTRF = (byte)cmTRF;
    Serial.write(dataToSentTRF);

    Serial.println(cmTRF);
    Serial.println(cmPing);

 
    
  //delay para receber os sinais dos sensores TRF e Ping
  delay(200);

  switch(cmd){
      case (0x01):
      //Led on
        digitalWrite(2,HIGH);
        break;
        
      case (0x02):
      //Led off
        digitalWrite(2,LOW);
        break;
        
      case(0x03):
      //Frente
        motorE.attach(13);
        motorD.attach(12);
        motorE.writeMicroseconds(1700);
        motorD.writeMicroseconds(-1700);
        break;
        
      case(0x04):
      //Direita
        motorE.attach(13);
        motorD.attach(12);
        motorE.writeMicroseconds(1700);
        motorD.writeMicroseconds(1700);
        delay(500);
        motorE.detach();
        motorD.detach();
        break;
        
      case(0x05):
      //Esquerda
        motorE.attach(13);
        motorD.attach(12);
        motorE.writeMicroseconds(1500);
        motorD.writeMicroseconds(1500);
        delay(450);
        motorE.detach();
        motorD.detach();
        break;
        
      case(0x06):
      //Ré
        digitalWrite(2,LOW);
        motorE.attach(13);
        motorD.attach(12);
        motorE.writeMicroseconds(-1700);
        motorD.writeMicroseconds(1700);
        digitalWrite(2,HIGH);
        break;
        
      case(0x07):
      //Parar
        motorE.detach();
        motorD.detach();
        break;

      case (0x0b):
      //180º
        motorE.attach(13);
        motorD.attach(12);
        motorE.writeMicroseconds(1700);
        motorD.writeMicroseconds(1700);
        delay(1700);
        motorE.detach();
        motorD.detach();
        break;
    }
}



//o valor medido pelo sensor TRF05
int leituraTRF(){
  
  digitalWrite(TrigPin, LOW); 
  delayMicroseconds(2);
  digitalWrite(TrigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(TrigPin, LOW);
  
  //pinMode(EcoPin, INPUT);
  durationTRF = pulseIn(EcoPin,HIGH);
  long distanceTRF_cm = distanceTRF(durationTRF);

  cmTRF = distanceTRF(durationTRF);
  return cmTRF;
}


long distanceTRF(long time){
  //Calcular distancia do TRF05
  
  long distanceCalcTRF;
  distanceCalcTRF = (((time /2.9)/2)/10);
  return distanceCalcTRF;
 }


//o valor medido pelo sensor Ping
int leituraPing(){
  
  pinMode(PingPin, OUTPUT);
  digitalWrite(PingPin, LOW);
  delayMicroseconds(2);
  digitalWrite(PingPin, HIGH);
  delayMicroseconds(5);
  digitalWrite(PingPin, LOW);

  pinMode(PingPin, INPUT);
  durationPing = pulseIn(PingPin,HIGH);

  cmPing = distancePing (durationPing);
  return cmPing;
}

long distancePing (long microseconds){
  return microseconds / 29 / 2;
}
